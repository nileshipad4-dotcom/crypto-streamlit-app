name: Collect Option Chain Data

on:
  schedule:
    - cron: "*/5 * * * *"       # Run every 10 minutes
  workflow_dispatch:              # Allow manual trigger

permissions:
  contents: write                 # Required so GitHub Actions can push

jobs:
  run-script:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------------------------
      # 1. CHECKOUT REPO (FULL HISTORY REQUIRED)
      # ---------------------------------------------------------
      - name: Checkout repo
        uses: actions/checkout@v3
        with:
          fetch-depth: 0         # MUST BE 0 for reset --hard to work

      # ---------------------------------------------------------
      # 2. SETUP PYTHON
      # ---------------------------------------------------------
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      # ---------------------------------------------------------
      # 3. INSTALL DEPENDENCIES
      # ---------------------------------------------------------
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas requests

      # ---------------------------------------------------------
      # 4. RUN COLLECTOR SCRIPT
      # ---------------------------------------------------------
      - name: Run the collector script
        run: python collector.py

      # ---------------------------------------------------------
      # 5. COMMIT & FORCE PUSH UPDATED DATA (NO MERGE CONFLICTS)
      # ---------------------------------------------------------
      - name: Commit and force-push updated CSV data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Bot identity
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # Stage new data produced by collector
          git add data/*
          git commit -m "data update $(date -u +"%Y-%m-%d %H:%M:%S UTC")" || echo "No changes"

          # Fetch latest state from GitHub
          git fetch origin main

          # Hard reset to avoid merge conflicts
          git reset --hard origin/main

          # Reapply the data changes
          git add data/*
          git commit -m "data update $(date -u +"%Y-%m-%d %H:%M:%S UTC")" || echo "No changes"

          # Force push ensures the CSV logs are always updated cleanly
          git push --force

